<!DOCTYPE html>
<html lang="en">
  <%- include('include/header', { title: 'calendar' }) %>
  <script
    defer
    src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"
  ></script>
  <body>
    <nav class="nav"><%- include('include/navi') %></nav>
    <main class="container calendar_wrap">
      <div class="content">
        <div class="calendar">
          <div class="header">
            <button id="prevMonth">&lt;</button>
            <h2 id="monthYear"></h2>
            <button id="nextMonth">&gt;</button>
          </div>
          <div class="days">
            <div>일</div>
            <div>월</div>
            <div>화</div>
            <div>수</div>
            <div>목</div>
            <div>금</div>
            <div>토</div>
          </div>
          <div class="dates" id="dates"></div>
        </div>

        <div class="todo-list">
          <h2>스케줄:</h2>
          <h3 id="selected-date"></h3>
          <ul id="todo-items"></ul>
        </div>
      </div>
    </main>

    <%- include('include/write-popup') %> <%- include('include/detail-popup') %>
    <script>
      const monthYear = document.getElementById('monthYear');
      const datesContainer = document.getElementById('dates');
      const prevMonth = document.getElementById('prevMonth');
      const nextMonth = document.getElementById('nextMonth');

      let currentDate = new Date();
      let monthTodos = [];

      async function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        monthYear.textContent = `${currentDate.toLocaleString('default', {
          month: 'long',
        })} ${year}`;

        const formattedMonth = String(month + 1).padStart(2, '0');
        const dateStr = `${year}-${formattedMonth}-01`;
        await fetchMonthTodos(dateStr);

        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();

        datesContainer.innerHTML = '';

        for (let i = 0; i < firstDay; i++) {
          const emptyDiv = document.createElement('div');
          datesContainer.appendChild(emptyDiv);
        }

        for (let i = 1; i <= lastDate; i++) {
          const dateDiv = document.createElement('div');
          dateDiv.classList.add('date');
          dateDiv.textContent = i;
          dateDiv.addEventListener('click', () =>
            selectDate(year, month + 1, i),
          );

          const formattedDay = String(i).padStart(2, '0');
          const formattedMonth = String(month + 1).padStart(2, '0');
          const dateKey = `${year}-${formattedMonth}-${formattedDay}`;
          const todosForDate = monthTodos.filter(
            (todo) => todo.date.split('T')[0] === dateKey,
          );

          if (todosForDate.length > 0) {
            dateDiv.classList.add('bg');
            if (
              window.matchMedia &&
              window.matchMedia('(prefers-color-scheme: dark)').matches
            ) {
              dateDiv.style.backgroundColor = '#ffffff';
              dateDiv.style.color = '#000000';
            } else {
              dateDiv.style.backgroundColor = '#e7c6ff5b';
            }
          }

          datesContainer.appendChild(dateDiv);
        }
      }

      async function fetchMonthTodos(dateStr) {
        try {
          const response = await fetch(`/todo/api/day?date=${dateStr}`);
          const result = await response.json();

          if (result.status === 'success') {
            monthTodos = result.data;
          } else {
            console.error('Failed to fetch todos:', result.message);
            monthTodos = [];
          }
        } catch (error) {
          console.error('Error fetching todos:', error);
          monthTodos = [];
        }
      }

      function selectDate(year, month, day) {
        const formattedMonth = String(month).padStart(2, '0');
        const formattedDay = String(day).padStart(2, '0');
        const dateKey = `${year}-${formattedMonth}-${formattedDay}`;

        const selectedDate = `${year}년 ${month}월 ${day}일`;
        document.getElementById('selected-date').textContent = selectedDate;

        const todoItems = document.getElementById('todo-items');
        todoItems.innerHTML = '';

        const todosForDate = monthTodos.filter(
          (todo) => todo.date.split('T')[0] === dateKey,
        );

        todosForDate.forEach((todo) => {
          const li = document.createElement('li');
          li.classList.add('todo-item');

          const todoTitle = document.createElement('div');
          todoTitle.style.cursor = 'pointer';
          todoTitle.textContent =
            todo.title ||
            (todo.TodoContents && todo.TodoContents[0]?.content) ||
            '제목 없음';

          todoTitle.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (window.handleTodoClick) {
              window.handleTodoClick(todo.id);
            } else {
              console.error('handleTodoClick 함수가 오류났습니다.');
            }
          };

          li.appendChild(todoTitle);
          todoItems.appendChild(li);
        });
      }

      prevMonth.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
      });

      nextMonth.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
      });

      renderCalendar();
      window.handleTodoClick = async function (todoId) {
        if (!todoId) {
          console.error('Todo ID is required');
          return;
        }

        try {
          const response = await axios.get(`/todo/api/get/${todoId}`);
          const todo = response.data.data;

          if (!todo) {
            throw new Error('Todo 데이터를 불러오지 못했습니다.');
          }

          window.currentTodoId = todoId;
          console.log('Todo ID set in handleTodoClick:', todoId);

          const detailPopup = document.querySelector('.detail-popup');
          const detailForm = document.forms['form-todo-detail'];

          detailForm.elements['todoTitle'].value = todo.title || '';
          detailForm.elements['todoDate'].value = todo.date || '';

          const priorityInput = detailForm.querySelector(
            `input[name="priority"][value="${todo.priority}"]`,
          );
          if (priorityInput) priorityInput.checked = true;

          const keywordSelect = detailForm.elements['todoKey'];
          if (keywordSelect) keywordSelect.value = todo.keyword_id || '';

          const todoContentList = detailForm.querySelector('.todo_content');
          todoContentList.innerHTML = '';

          if (todo.todo_contents && todo.todo_contents.length > 0) {
            todo.todo_contents.forEach((content) => {
              const li = document.createElement('li');
              li.dataset.contentId = content.id;
              li.innerHTML = `
                    <label>
                        <input type="checkbox" name="todoChk" ${
                          content.state ? 'checked' : ''
                        } disabled>
                        <input type="text" name="todoCon" value="${
                          content.content || ''
                        }" disabled>
                    </label>
                `;
              todoContentList.appendChild(li);
            });
          } else {
            const li = document.createElement('li');
            li.innerHTML = `
                <label>
                    <input type="checkbox" name="todoChk" disabled>
                    <input type="text" name="todoCon" value="내용 없음" disabled>
                </label>
            `;
            todoContentList.appendChild(li);
          }

          detailPopup.classList.add('on');
          document.body.classList.add('pop_open');
        } catch (error) {
          console.error('Failed to load todo details:', error);
          alert('Todo 상세 정보를 불러오는 데 실패했습니다.');
        }
      };
    </script>
  </body>
</html>
