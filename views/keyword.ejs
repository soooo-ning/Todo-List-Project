<!DOCTYPE html>
<html lang="en">
  <%- include('include/header', { title: 'keyword' }) %>
  <body>
    <nav class="nav"><%- include('include/navi') %></nav>

    <main class="container keyword_wrap">
      <div class="content">
        <h3 class="sub_title">
          <span>
            <% if (todos.length > 0 && todos[0].keyword) { %> <%=
            todos[0].keyword.keyword %> <% } else { %> 키워드 할 일 <% } %>
          </span>
        </h3>
        <div class="card-container add">
          <% if (todos && todos.length > 0) { %> <% todos.forEach((todo) => { %>
          <div class="card" data-id="<%= todo.id %>">
            <div class="card-title"><%= todo.title %></div>
            <% if (todo.todo_contents && todo.todo_contents.length > 0) { %>
            <ul class="todo-list-all">
              <% todo.todo_contents.forEach((content) => { %>
              <li class="<%= content.state ? 'completed' : '' %>">
                <%= content.content %>
              </li>
              <% }); %>
            </ul>
            <% } %>
          </div>
          <% }); %> <% } else { %>
          <div class="no-todos">이 키워드에 해당하는 할 일이 없습니다.</div>
          <% } %>
        </div>
      </div>
    </main>

    <%- include('include/write-popup') %> <%- include('include/detail-popup') %>
    <script>
      function escapeHtml(string) {
        if (!string) return '';
        return string
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      window.handleTodoClick = async function (todoId) {
        if (!todoId) {
          console.error('Todo ID is required');
          return;
        }

        try {
          const response = await axios.get(`/todo/api/get/${todoId}`);
          const todo = response.data.data;

          if (!todo) {
            throw new Error('Todo 데이터를 불러오지 못했습니다.');
          }

          window.currentTodoId = todoId;

          const detailPopup = document.querySelector('.detail-popup');
          const detailForm = document.forms['form-todo-detail'];

          // 기본 정보 설정
          detailForm.elements['todoTitle'].value = todo.title || '';
          detailForm.elements['todoDate'].value = todo.date || '';

          const priorityInput = detailForm.querySelector(
            `input[name="priority"][value="${todo.priority}"]`,
          );
          if (priorityInput) priorityInput.checked = true;

          const keywordSelect = detailForm.elements['todoKey'];
          if (keywordSelect) keywordSelect.value = todo.keyword_id || '';

          // todo 내용 리스트 초기화 및 추가
          const todoContentList = detailForm.querySelector('.todo_content');
          todoContentList.innerHTML = '';

          if (todo.todo_contents && todo.todo_contents.length > 0) {
            todo.todo_contents.forEach((content) => {
              addContentItem(content);
            });
          } else {
            addContentItem({ content: '내용 없음', state: false });
          }

          // 팝업 표시
          detailPopup.classList.add('on');
          document.body.classList.add('pop_open');
        } catch (error) {
          console.error('Failed to load todo details:', error);
          alert('Todo 상세 정보를 불러오는 데 실패했습니다.');
        }
      };

      // DOM 로드 시 이벤트 리스너 설정
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.card').forEach((card) => {
          card.addEventListener('click', () => {
            const todoId = card.dataset.id;
            if (!todoId) {
              console.error('Todo ID is missing.');
              return;
            }
            window.handleTodoClick(todoId);
          });
        });
      });
    </script>
  </body>
</html>
