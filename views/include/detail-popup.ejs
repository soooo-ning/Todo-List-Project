<div class="container popup detail-popup">
  <div class="pop_con">
    <h3 class="sub_title">
      <span>Todo Detail</span>
    </h3>
    <button type="button" class="pop_close">X</button>
    <form name="form-todo-detail" method="post">
      <label class="todo_title">
        <input
          type="text"
          name="todoTitle"
          placeholder="제목을 입력하세요"
          required
          disabled
        />
      </label>

      <div class="todo_input">
        <label class="calendar_input">
          <input
            type="text"
            id="detail-datetime-input"
            name="todoDate"
            placeholder="날짜를 입력하세요"
            disabled
          />
          <div class="calendar_pop" style="display: none"></div>
        </label>

        <div class="priority">
          <p>우선순위</p>
          <label>
            <input type="radio" name="priority" value="high" disabled />
            상
          </label>
          <label>
            <input type="radio" name="priority" value="medium" disabled />
            중
          </label>
          <label>
            <input type="radio" name="priority" value="low" disabled />
            하
          </label>
        </div>

        <label class="todo_key">
          <p>키워드</p>
          <select name="todoKey" disabled>
            <% if (keywords && keywords.length > 0) { %> <% for (let i = 0; i <
            keywords.length; i++) { %>
            <option value="<%= keywords[i].id %>">
              <%= keywords[i].keyword %>
            </option>
            <% } %> <% } else { %>
            <option value="">No Keywords Available</option>
            <% } %>
          </select>
        </label>
      </div>

      <ul class="todo_content"></ul>
      <button type="button" id="addContentBtn" style="display: none">
        추가
      </button>

      <div class="button-group">
        <button type="button" id="todoEdit">수정</button>
        <button type="submit" id="todoSubmit" style="display: none">
          등록
        </button>
        <button type="button" id="todoDelete">삭제</button>
      </div>
    </form>
  </div>
</div>

<script>
  let currentTodoId = null;
  let isEditMode = false;
  let detailForm = null;
  let todoEditBtn = null;
  let todoSubmitBtn = null;
  let todoDeleteBtn = null;
  let addContentBtn = null;
  let dateInput = null;
  let calendarPopup = null;

  // 내용 항목 추가
  function addContentItem(content = { id: null, content: '', state: false }) {
    if (window.currentTodoId) {
      currentTodoId = window.currentTodoId;
    }

    const todoContentList = detailForm.querySelector('.todo_content');
    if (!todoContentList) return;

    const li = document.createElement('li');
    li.dataset.contentId = content.id || '';
    li.innerHTML = `
        <label>
          <input type="checkbox" name="todoChk" ${
            content.state ? 'checked' : ''
          } ${isEditMode ? '' : 'disabled'}>
          <input type="text" name="todoCon" value="${escapeHtml(
            content.content || '',
          )}"
          placeholder="할일을 입력하세요" ${isEditMode ? '' : 'disabled'}>
          <button type="button" class="delete-content" style="display: none">delete</button>
        </label>
    `;
    todoContentList.appendChild(li);

    const deleteBtn = li.querySelector('.delete-content');
    if (deleteBtn) {
      deleteBtn.addEventListener('click', () => {
        if (todoContentList.children.length > 1) {
          li.remove();
          updateDeleteButtons();
        } else {
          alert('최소 하나의 내용 항목이 필요합니다.');
        }
      });
    }

    updateDeleteButtons();
  }

  // 삭제 버튼 상태 업데이트
  function updateDeleteButtons() {
    const todoContentList = detailForm.querySelector('.todo_content');
    if (!todoContentList) return;

    const listItems = todoContentList.querySelectorAll('li');
    const deleteButtons = todoContentList.querySelectorAll('.delete-content');
    const shouldShow = isEditMode; // 수정모드일 때는 항상 삭제 버튼 표시

    deleteButtons.forEach((btn) => {
      btn.style.display = shouldShow ? 'inline-block' : 'none';
    });

    // 마지막 하나의 항목만 남았을 때는 삭제 버튼 숨기기
    if (listItems.length === 1) {
      const lastDeleteButton = listItems[0].querySelector('.delete-content');
      if (lastDeleteButton) {
        lastDeleteButton.style.display = 'none';
      }
    }
  }

  // 폼 초기화 함수
  function resetDetailForm() {
    if (!detailForm) return;

    isEditMode = false;
    detailForm.reset();

    const todoContentList = detailForm.querySelector('.todo_content');
    if (todoContentList) todoContentList.innerHTML = '';

    enableFormEditing(false);
    updateDeleteButtons();

    if (todoEditBtn) todoEditBtn.style.display = 'inline-block';
    if (todoSubmitBtn) todoSubmitBtn.style.display = 'none';
    if (addContentBtn) addContentBtn.style.display = 'none';
  }

  // 수정 가능/불가능 토글
  function enableFormEditing(enabled) {
    if (!detailForm) return;

    isEditMode = enabled;

    const formElements = detailForm.elements;
    for (let element of formElements) {
      if (element.type !== 'button' && element.type !== 'submit') {
        element.disabled = !enabled;
      }
    }

    const todoContentList = detailForm.querySelector('.todo_content');
    if (todoContentList) {
      const contentItems = todoContentList.querySelectorAll('li');
      contentItems.forEach((item) => {
        const inputs = item.querySelectorAll(
          'input[type="checkbox"], input[name="todoCon"]',
        );
        inputs.forEach((input) => {
          input.disabled = !enabled;
        });
      });
    }

    if (addContentBtn) {
      addContentBtn.style.display = enabled ? 'inline-block' : 'none';
    }

    updateDeleteButtons();
  }

  // XSS 방지
  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  // DOM 로드 완료 시 초기화
  document.addEventListener('DOMContentLoaded', () => {
    // DOM 요소 초기화
    detailForm = document.forms['form-todo-detail'];
    todoEditBtn = document.getElementById('todoEdit');
    todoSubmitBtn = document.getElementById('todoSubmit');
    todoDeleteBtn = document.getElementById('todoDelete');
    addContentBtn = document.getElementById('addContentBtn');
    dateInput = document.getElementById('detail-datetime-input');
    calendarPopup = detailForm?.querySelector('.calendar_pop');

    // 이벤트 리스너 설정
    if (todoEditBtn) {
      todoEditBtn.addEventListener('click', () => {
        isEditMode = true;
        if (todoEditBtn) todoEditBtn.style.display = 'none';
        if (todoSubmitBtn) todoSubmitBtn.style.display = 'inline-block';

        enableFormEditing(true);
        updateDeleteButtons();
      });
    }

    // 수정 제출 핸들러
    if (todoSubmitBtn) {
      todoSubmitBtn.addEventListener('click', async (event) => {
        event.preventDefault();

        if (!currentTodoId) {
          alert('Todo 정보를 찾을 수 없습니다.');
          return;
        }

        const formData = {
          id: currentTodoId,
          keyword_id:
            detailForm.querySelector('[name="todoKey"]').value || null,
          title: detailForm.querySelector('[name="todoTitle"]').value.trim(),
          priority: detailForm.querySelector('[name="priority"]:checked')
            ?.value,
          date: detailForm.querySelector('[name="todoDate"]').value,
          contents: Array.from(detailForm.querySelectorAll('.todo_content li'))
            .map((li) => ({
              id: li.dataset.contentId || null,
              content: li.querySelector('[name="todoCon"]').value.trim(),
              state: li.querySelector('[type="checkbox"]').checked,
            }))
            .filter((content) => content.content !== ''),
        };

        try {
          const response = await axios.patch('/todo/api/edit', formData);
          alert('Todo가 성공적으로 수정되었습니다.');
          window.location.reload();
        } catch (error) {
          console.error('Todo 수정 실패:', error);
          alert('Todo 수정 중 오류가 발생했습니다.');
        }
      });
    }

    // 삭제 버튼 클릭 이벤트
    if (todoDeleteBtn) {
      todoDeleteBtn.addEventListener('click', async () => {
        if (!currentTodoId) {
          console.error('No todo ID found');
          alert('Todo 정보를 찾을 수 없습니다.');
          return;
        }

        if (confirm('정말 삭제하시겠습니까?')) {
          try {
            const response = await axios.delete('/todo/api/delete', {
              data: { id: currentTodoId },
            });

            if (response.data.status === 'success') {
              alert('삭제되었습니다.');
              document.querySelector('.detail-popup').classList.remove('on');
              document.querySelector('body').classList.remove('pop_open');
              window.location.reload();
            }
          } catch (error) {
            console.error('Todo 삭제 실패:', error);
            alert('삭제에 실패했습니다.');
          }
        }
      });
    }

    // 팝업 닫기 버튼 이벤트
    const detailPopClose = document.querySelector('.detail-popup .pop_close');
    if (detailPopClose) {
      detailPopClose.addEventListener('click', () => {
        document.querySelector('.detail-popup').classList.remove('on');
        document.querySelector('body')?.classList.remove('pop_open');
        resetDetailForm();
      });
    }

    // 내용 추가 버튼 이벤트
    if (addContentBtn) {
      addContentBtn.addEventListener('click', () => {
        addContentItem();
      });
    }

    // 달력 관련 이벤트
    if (dateInput && calendarPopup) {
      dateInput.addEventListener('click', (e) => {
        e.stopPropagation();
        generateCalendar();
        calendarPopup.style.display = 'block';
      });

      document.addEventListener('click', (e) => {
        if (
          calendarPopup.style.display === 'block' &&
          !calendarPopup.contains(e.target) &&
          e.target !== dateInput
        ) {
          calendarPopup.style.display = 'none';
        }
      });

      calendarPopup.addEventListener('click', (e) => {
        const td = e.target;
        if (
          td.tagName === 'TD' &&
          !td.classList.contains('disabled') &&
          td.dataset.date
        ) {
          dateInput.value = td.dataset.date;
          calendarPopup.style.display = 'none';
        }
      });
    }
  });
</script>
